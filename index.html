<script>
  const input = document.getElementById('cnpj');
  const razao = document.getElementById('razao');
  let cnpjValido = '';
  let nomeEmpresa = '';

  input.addEventListener('blur', async () => {
    const cnpj = input.value.replace(/\D/g, '');
    if (cnpj.length !== 14) {
      razao.textContent = "CNPJ inválido.";
      cnpjValido = '';
      nomeEmpresa = '';
      return;
    }

    razao.textContent = "Buscando razão social...";

    try {
      const res = await fetch(`/api/razao-social?cnpj=${cnpj}`);
      const data = await res.json();

      if (data.razaoSocial) {
        razao.textContent = `Razão social: ${data.razaoSocial}`;
        cnpjValido = cnpj;
        nomeEmpresa = data.razaoSocial;
      } else {
        razao.textContent = "Razão social não encontrada.";
      }
    } catch {
      razao.textContent = "Erro ao buscar razão social.";
    }
  });

  function redirecionar() {
    if (!cnpjValido || !nomeEmpresa) {
      alert("Preencha um CNPJ válido antes de continuar.");
      return;
    }

    window.location.href = `/api/gerar-link?cnpj=${cnpjValido}`;
  }
</script>
